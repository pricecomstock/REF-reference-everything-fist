# PWA Features

This document describes the Progressive Web App (PWA) features implemented in the FIST Reference application.

## Features

### 1. **Offline Support**
- The app works completely offline after the first visit
- All static assets (JS, CSS, images) are cached automatically
- Data files (__data.json) are cached with a stale-while-revalidate strategy
- If you visit a page while online, it will be available offline

### 2. **Installable**
- The app can be installed on your device (mobile or desktop)
- On mobile: Look for "Add to Home Screen" in your browser menu
- On desktop (Chrome/Edge): Look for the install icon in the address bar
- Once installed, it runs as a standalone app

### 3. **Intelligent Caching**
- **Static assets**: Cached indefinitely and updated when the app version changes
- **Data files**: Cached for up to 30 days with automatic staleness detection
- **Images**: Cached separately with a limit of 100 images for 60 days

### 4. **Cache Update Notifications**
- You'll be notified when a new version of the app is available
- You'll be notified when your cached data is older than 30 days
- You can manually clear the cache if needed

### 5. **Offline Fallback Page**
- If you try to visit a page that's not cached while offline, you'll see a helpful offline page
- The offline page automatically detects when you're back online and redirects you

## How It Works

### Service Worker
The app uses a service worker (generated by Workbox) to:
- Cache static files during installation
- Intercept network requests and serve from cache when offline
- Update cache in the background while serving stale content

### Caching Strategies

1. **CacheFirst** (Images):
   - Serves from cache if available
   - Falls back to network if not in cache
   - Updates cache with network response

2. **StaleWhileRevalidate** (Data files):
   - Serves from cache immediately
   - Fetches from network in background
   - Updates cache with fresh data for next time
   - Respects 30-day expiry

3. **NetworkFirst** (Navigation):
   - Tries network first
   - Falls back to cache if offline
   - Shows offline page if not in cache

### Cache Lifecycle

```
1. First Visit (Online)
   ├─ Service worker installs
   ├─ Static assets cached
   └─ Data cached on page visits

2. Return Visit (Online)
   ├─ Serves from cache (instant load)
   ├─ Updates in background
   └─ Notifies if new version available

3. Offline Visit
   ├─ Serves entirely from cache
   └─ Updates when back online

4. After 30 Days
   ├─ Cache marked as stale
   ├─ User notified
   └─ Can clear cache to refresh
```

## User Experience

### First Time Users
1. Visit the site
2. Browse pages (they get cached)
3. Get notification: "Ready for Offline Use"
4. Can now use offline

### Returning Users (Online)
1. Visit the site
2. See cached version immediately (instant load)
3. Data updates in background
4. Get notified if app update available

### Offline Users
1. Open the app (works even without internet)
2. All previously visited pages work
3. Can use random generators, search, etc.
4. Redirect to home page when back online

## Technical Details

### Configuration
- PWA config: `vite.config.ts`
- Service worker: Auto-generated by `@vite-pwa/sveltekit`
- Manifest: Auto-generated with proper icons and theme colors
- Store logic: `src/lib/stores/pwa.ts`

### Files
- `manifest.webmanifest`: PWA manifest with app metadata
- `sw.js`: Service worker for offline functionality
- `workbox-*.js`: Workbox runtime for caching strategies
- `/offline`: Offline fallback page

### Cache Names
- `workbox-precache-*`: Static assets (JS, CSS, HTML)
- `fist-ref-data`: Data files with 30-day expiry
- `fist-ref-images`: Images with 60-day expiry

## Development

### Testing Offline Mode

**IMPORTANT**: PWA features only work in production builds, not in dev mode (`pnpm run dev`).

#### Correct Testing Procedure:

1. **Build the app**: `pnpm run build`
2. **Start preview server**: `pnpm run preview`
3. **Visit the site** at http://localhost:4173/
4. **Wait for service worker to install**:
   - Open DevTools > Application > Service Workers
   - You should see the service worker "activated and running"
5. **Navigate to pages** you want to test offline (e.g., /role/cultist, /traits, etc.)
   - These pages will be cached as you visit them
6. **Refresh the page once** to ensure service worker has full control
7. **Now test offline**:
   - In DevTools > Application > Service Workers
   - Check "Offline" checkbox
   - Navigate to previously visited pages - they should work!
8. **For new pages**: Pages you haven't visited won't work offline - you'll see the `/offline` fallback page

#### Why This Process is Necessary:

- Service workers don't take control on first visit
- Pages are cached with `NetworkFirst` strategy (only after you visit them)
- A refresh is needed after SW installation for full control
- Dev mode (`pnpm run dev`) has PWA disabled for better development experience

### Clearing Cache
Users can clear cache via:
1. Notification when cache is stale
2. Browser DevTools (Application > Clear storage)

### Updating the App
When you deploy a new version:
1. Service worker detects new version
2. Downloads new assets in background
3. Notifies user: "Update Available"
4. User clicks "Update" to reload with new version

## Browser Support
- ✅ Chrome/Edge (Desktop & Mobile)
- ✅ Firefox (Desktop & Mobile)
- ✅ Safari (iOS 11.3+, macOS)
- ✅ Samsung Internet
- ⚠️ Older browsers will work but without offline features

## Troubleshooting

### PWA Not Installing
- Check that you're using HTTPS (required for PWA)
- Verify manifest is accessible: `/manifest.webmanifest`
- Check browser console for errors

### Offline Not Working
- Make sure you've visited pages while online first
- Check Service Worker status in DevTools
- Try clearing cache and revisiting while online

### Cache Issues
- Use the "Clear Cache" button in the stale cache notification
- Or manually clear in DevTools > Application > Clear storage
- Refresh the page after clearing

## Future Improvements
- Background sync for offline actions
- Push notifications for updates
- More granular cache control per content type
- Periodic background sync to keep data fresh
